---
title: "Group 7 Final Project"
author: "Olivia Guza, Katelyn Wang, Elena Fries"
date: "2023-09-15"
output: html_document
---

# NFL Attendance

## Introduction

Over the last few decades, the NFL has seen a decrease in revenue. NFL officials, team owners, and marketers need analysis on game attendance records in order to increase revenue and fan engagement. To address this problem, we plan to join the attendance and games datasets for more complete analysis of game attendance factors. We will utilize descriptive analysis to see trends and patterns over time for each team. We will create time series plots to see if there are patterns in attendance based on the week. We also will look into patterns of attendance based on the day of the week and the time of day. Our analysis will help team owners and marketers because higher attendance generates more revenue for them through tickets sales, merchandise, and concessions. It will allow them to make more informed decisions about increasing fan engagement and maximizing pricing, NFL officials can make informed decisions about scheduling & which teams to feature in prime-time slots, and marketers can better segment fans to make personalized promotions and marketing strategies.

## Required Packages

We loaded the tidyverse package as it contains many functions that are going to be useful with data importation, tidying, manipulation, and data visualization. We load the ggplot2 package as it contains many powerful and flexible frameworks to create data visualizations.  We included the a snippet in the code chunk header to control how R code is executed and displayed when rendering the document.

echo=FALSE prevents the R code itself will be displayed in the output document.

message=FALSE: This option controls whether the messages generated by R during the code execution will be displayed in the output document. 

warning=FALSE: Similar to message, this option controls whether warnings generated by R during the code execution will be displayed in the output document.
```{r, echo=FALSE, message=FALSE, warning=FALSE}
library(tidyverse)
library(ggplot2)
```

## Data Importation and Preparation

Original purpose: For the attendance csv it was to collect basic information on the attendance of each team every year. For the games csv it was to collect basic information on the details of each game like the specific day, time, and teams playing. We used the read_csv function to import the datasets.
```{r}
attendance <- read_csv("attendance.csv")
games <- read_csv("games.csv")
```
Summarize the data in the attendance dataset.
Code: Use the nrow() function to calculate the number of observations in the datset and the ncol() function to calculate the number of variables.  Use the sapply() function to apply the class() function to each column of the "attendance" dataset. It generates a vector of the data types (classes) of each variable in the dataset.  Use the sum() function to add up the number of categorical and quantitative variables in the dataset.  Finally, the cat() function is used to print the results.
```{r}
attendance_observations <- nrow(attendance)
attendance_variables <- ncol(attendance)

variable_classes <- sapply(attendance, class)
num_attendance_categorical <- sum(variable_classes == "factor" | variable_classes == "character")
num__attendance_quantitative <- sum(variable_classes == "numeric")

cat("Number of Observations:", attendance_observations, "\n")
cat("Number of Variables:", attendance_variables, "\n")
cat("Number of Categorical Variables:", num_attendance_categorical, "\n")
cat("Number of Quantitative Variables:", num__attendance_quantitative, "\n")
```
Summarize the data in the games dataset
Code: Use the nrow() function to calculate the number of observations in the datset and the ncol() function to calculate the number of variables.  Use the sapply() function to apply the class() function to each column of the "games" dataset. It generates a vector of the data types (classes) of each variable in the dataset.  Use the sum() function to add up the number of categorical and quantitative variables in the dataset.  Finally, the cat() function is used to print the results.
```{r}
games_observations <- nrow(games)
games_variables <- ncol(games)

variable_classes1 <- sapply(games, class)
num_games_categorical <- sum(variable_classes1 == "factor" | variable_classes1 == "character")
num_games_quantitative <- sum(variable_classes1 == "numeric")

cat("Number of Observations:", games_observations, "\n")
cat("Number of Variables:", games_variables, "\n")
cat("Number of Categorical Variables:", num_games_categorical, "\n")
cat("Number of Quantitative Variables:", num_games_quantitative, "\n")
```
Next we calculated the number of missing values in the two data frames.  We used the sum(is.na()) function to complete this task.  There are 639 missing values in the attendance data set and 5314 in the games data set. A lot of these could be due to bye weeks.
```{r}
sum(is.na(attendance))
sum(is.na(games))
```

We replaced the missing values in the weekly_attendance column of the attendance data set with the median of the column so that we could still efficiently analyze the data without it being skewed. When you replace missing values with the median, you maintain the overall distribution of the data, which can be important for preserving the integrity of your dataset. Also, imputing missing values with the median is a simple method that does not introduce bias into the dataset. Some more complex imputation methods may introduce bias or require assumptions about the data distribution.
```{r}
attendance %>%
  mutate(weekly_attendance= ifelse(is.na(weekly_attendance), median(weekly_attendance, na.rm = TRUE), weekly_attendance))
```

We removed the tie column from the games data set as it contained a lot of missing values and we are not going to be utilizing that column in our analysis, and doing so removed all missing values in our data set.
```{r}
games <- games[, -6]
sum(is.na(games))
```

In order to gain an understanding of the collection timeline of the data we will use the head() and tail() function on the games data set.  We will use the games data set because it provides specific dates and days of games as opposed to just months and years.
Collection timeline: (September 3, 2000 - February 2, 2019)
```{r}

head(games)
tail(games)
```

## Cleaned Data Sets

After we have replaced missing values from the attendance data set with the median of the column and removed the tie column from the games data set, our data is cleaned and ready to be analyzed. Given the large number of missing values, replacing those missing values with the median allows us to do analysis without the considerable bias that would come from the missing values. Additionally, removing the tie column since we won't need it for our analysis allows a cleaner and more concise data set to work with. 

## Proposed Explanatory Data Analysis 

We hope to use descriptive analysis tools to discover patterns and trends. We can also do analysis on days of the week and times that the games are to see if there are any patterns there. This will allow us to single out some variables and analyze their impacts on fan engagement. 

Merge columns team and team_name so that our analysis can have both the team city and team name as one. To do this, we run the team and team_name columns through paste() function and assign it to a new column called team_full_name. Then, we move the new column, team_full_name, to the first column of the data frame for clarity. Lastly, we remove the previous team and team_name columns to prevent confusion and reptition of information. 
```{r}
attendance$team_full_name <- paste(attendance$team, attendance$team_name)

attendance_column_names <- names(attendance)
attendance <- attendance[,c("team_full_name", attendance_column_names[-9])]

attendance <- attendance[, -c(2,3)]

attendance
```
We want to use a line plot to better visualize trends and patterns over time for each team. We can also use bar plots to identify correlations between different days of the week and attendance. 

To narrow down our dataset, we decided to use the top 6 highest attendance in 2019. We found that the top 6 teams are Dallas Cowboys, Green Bay Packers, Los Angeles Rams, New York Giants, Philadelphia Eagles, Buffalo Bills. First, we filter the year to 2019 in the attendance dataset and arrange it in descending order by the total attendance and assign it to top_attendance_2019. Then, to find the top 6 teams to analyze, we use the head() function and distinct() function to list the top 6 and remove non-unique team_full_name. 
```{r}
top_attendance_2019 <- attendance %>%
  filter(year == 2019) %>%
  arrange(desc(total))

head(distinct(top_attendance_2019, team_full_name))
```

We created new data frames with just the teams we are focusing on for the 2019 season.
```{r}
top_attendance_2019
top_teams_2019 <- top_attendance_2019 %>%
  filter(team_full_name == "Dallas Cowboys" | team_full_name == "Green Bay Packers" | team_full_name == "Los Angeles Rams" | team_full_name == "New York Giants" | team_full_name == "Philadelphia Eagles" | team_full_name == "Buffalo Bills")
top_teams_2019
```


```{r}
top_games_2019 <- games %>%
  filter(year == 2019)
top_games_2019_teams <- top_games_2019 %>%
  filter(home_team_name == "Cowboys" | home_team_name == "Packers" | home_team_name == "Rams" | home_team_name == "Giants" | home_team_name == "Eagles" | home_team_name == "Bills" | away_team_name == "Cowboys" | away_team_name == "Packers" | away_team_name == "Rams" | away_team_name == "Giants" | away_team_name == "Eagles" | away_team_name == "Bills")
```
Purpose: Next we create our line plot that visualizes the weekly attendance of different football teams over a series of weeks in their 2019 season.
Code Comments: Use the ggplot() function to initialize a ggplot object.  It tells ggplot to use the 'top_teams_2019' data frame for plotting and specifies the mapping of variables to aesthetic properties. In this case: 'x = week' maps the 'week' column to the x-axis, 'y = weekly_attendance' maps the 'weekly_attendance' to the y-axis, and 'color = team_full_name' defines the color of the lines on the plot so that each unique team name will be associated with a different color.  Use 'geom_line()' function to add a line layer to the plot.  The 'labs()' function sets the labels for the plot.  Finally, 'theme_minimal' applies a minimal theme to the plot.
Insights: The line plot helps to identify peak attendance weeks (e.g., playoffs or rivalry games) and low attendance weeks. Understanding when and why attendance varies can provide insights into factors affecting fan engagement.  While there does not seem to be seasonal trends in attendance, the line graph gives us a broader idea of the top 6 teams attendance for each week and the areas to dive deeper into.  For example, the line graph shows a large dip in attendance for the Green Bay Packers in week 9 so it may be noteworthy to further analyze that week to learn what factors caused the dip.
```{r}
top_teams_2019
ggplot(top_teams_2019, aes(x = week, y = weekly_attendance, color = team_full_name)) +
  geom_line() +
  labs(
    title = "Football Team Attendance Over Weeks",
    x = "Week",
    y = "Attendance"
  ) +
  theme_minimal()
```
Next, we want to further identify patterns in attendance based on weeks through a bargraph. 
Code Comments: Use the select() function to choose the team_full_name, week, and weekly_attendance from top_teams_2019 and assign to attendance_by_week2019. Then, to ensure that the plot does not default to using scientific notation, use options(scipen = 999). Then use the ggplot() function to reference the attendance_by_week_2019 and use factor(week) as the x-axis and weekly_attendance as the y-axis. Also include na.rm = TRUE to remove missing values. Then use the geom_bar() function to let R know we want a bar plot. The argument stat= "identity" uses values of weekly_attendance directly as heights of the bars and fill = team_full_name specifies the fill color for bars based on the column. facet_wrap() allows us to create multiple small plots based on team_full_name. Then, we use labs() to label the graph appropriately. 
Insights: There is always one week with no attendance for all 6 identified top attendance teams due to Bye weeks. In most cases, other than Green Bay Packers, there aren't significant dips in attendance, but there are certain weeks that have higher attendance. This could be due to that game being a home game or due to a previous win or even the day of the week the game is played. Unique fan engagement could also play a role in some of these patterns since the Philadelphia Eagles see a relatively stable attendance record. The Dallas Cowboys have more variance by week, but also have the highest attendance on weeks where their attendance peaks. We dove into Dallas Cowboys and potential reasons for their ups and downs in attendance. Turns out, Cowboys fans tend to only go to home games. 
```{r}
attendance_by_week_2019 <- top_teams_2019 %>%
  select(team_full_name, week, weekly_attendance)

options(scipen = 999)
ggplot(attendance_by_week_2019, aes(x = factor(week), y = weekly_attendance), na.rm = TRUE) + geom_bar(stat = "identity", aes(fill = team_full_name)) + facet_wrap (~team_full_name) + labs(title = "Attendance By Week", x = "Week", y = "Attendance", fill = "Team Name") + theme(axis.text.x = element_text(size = 5))
```
We then created a data frame using the attendance data set and used the mutate() function to add a win/loss variable so that we could evaluate if there is any impact on attendance after a win or a loss.
```{r}
top_teams_2019_results <- top_teams_2019 %>%
  mutate(result = c("W", "W", "W", "L", "L", "L", "W", "Bye", "W", "L", "W", "L", "L", "L", "W", "L", "W", "W", "W", "W", "L", "W", "W", "W", "W", "L", "W", "Bye", "L", "W", "W", "W", "W", "W", "W", "W", "W", "L","L", "L", "W", "W","Bye", "L", "W", "L", "W", "W", "L", "L", "W", "L", "L", "W", "W", "L", "L", "L", "L", "L", "L", "Bye", "L", "L", "L", "W", "W", "L", "W", "L", "L", "W", "W", "L", "L", "W", "W", "Bye", "L", "L", "L", "W", "W", "W", "W", "W", "W", "W", "L", "W", "Bye", "W", "L", "W", "L", "W", "W", "W", "L", "W", "L", "L"))
top_teams_2019_results
top_teams_2019_results <- data.frame(top_teams_2019_results)
```

We also wanted to try to understand if there was any impact on attendance after a win or loss, so we decided to create a scatter plot to show the attendance for each week and filled each point to be green if they won and red if they lost. 
Code Comments: Used ggplot() function to reference the top_teams_2019_results and use week as the x-axis, weekly_attendance as the y-axis, and result to color the points on the graph. Then used geom_point function to tell R that we want a scatter plot. scale_color_manual is a function that manually sets colors for data points in a plot, allowing you to override the default colors for your own colors in the data. facet_wrap() allowed us to create multiple small plots based on team_full_name. Then, we used labs() to label the graph appropriately. Finally, we applied theme_mininal() to the plot to create a clean, minimalistic look to the plot. 
Insights: There doesn't seem to be any strong correlation between a win or loss in one week and attendance the following week. There are certain weeks that do have higher attendance than what appears to be the norm for several of the teams, and we contribute this to being more competitive games, or games at "special" times, such as Sunday night, Monday night, or Thursday night, as those games tend to be more watched and more popular. The New York Giants had very strong attendance in week 1, which fell significantly after their week 1 loss and did not ever reach even close to that level again. Considering the Giants only had 5 wins for the 2018 season, we believe that the Giants fans likely had hope that the next season would be better and were disappointed after their week 1 loss, and rightfully so as they went on to win only 4 games in 2019. Additionally, as we have already discussed, we can see that the Dallas Cowboys have pretty variable attendance levels, more than any of the other teams we looked at due to the fact that Cowboys fans primarily attend home games. 
```{r}
top_teams_2019_results %>%
  ggplot(aes(x = week, y = weekly_attendance, color = result)) +
  geom_point() +
  scale_color_manual(values = c("W" = "green", "L" = "red")) +
  facet_wrap(~team_full_name) +
  labs (x = "Week", y = "Weekly Attendance") +
  theme_minimal()
```


We currently do not know how to use machine learning techniques in R Studio. We believe that to better understand the relationship between games and attendance, officials could use a linear regression to model the relationship between home games and attendance and to view the relationship between away games and attendance. By doing this NFL officials could gain a better idea of whether a game is home or away will have a significant impact in the attendance of said game.

## Conclusion

In order to address the NFL's problem of decreasing revenue, we plan to perform an analysis on game attendance records in order to increase revenue and fan engagement for NFL officials, team owners, and marketers. To do this, we first loaded the tidyverse package and imported the attendance and games data sets. We then looked at the structure of the data sets and the missing values to determine if there was any manipulation that needed done for us to perform our analysis. We took care of the missing values in the attendance data set by importing the median value to efficiently analyze the data without it being skewed and removed the tie column from the games data set as it contained a lot of missing values and was not necessary in our analysis. We then used the head() and tail() functions to determine the collection timeline of our data sets, which we found to be September 3, 2000 to February 2, 2019. For our proposed explanatory data analysis, we will first join the two data sets to give us a better understanding of the factors that affect game attendance. We will segment the home and away categories, perform analysis on days of the week and times of day to see if these are significant factors that affect game attendance. To visualize our data, we will use time series plots and bar plots to visualize trends over time and identify correlations. Finally, we will learn how to use linear regression so that we can model the relationship between venue and attendance to gain a better understanding of whether the venue has a significant impact on attendance. After performing all of these actions, we hope that we will have an answer for NFL officials, team owners, and marketers on how they should move forward to increase revenue. 

We first loaded the tidyverse package and imported the attendance and games data sets. We then looked at the structure of the data sets and the missing values to determine if there was any manipulation that needed done for us to perform our analysis. We took care of the missing values in the attendance data set by importing the median value to efficiently analyze the data without it being skewed and removed the tie column from the games data set as it contained a lot of missing values and was not necessary in our analysis. Imputing missing values with the median is a simple method that does not introduce bias into the dataset.  We then used the head() and tail() functions to determine the collection timeline of our data sets, which we found to be September 3, 2000 to February 2, 2019.

Our approach to this issue includes various descriptive analysis techniques. Before we could perform these techniques, we had to create tables based on subsets of the existing datasets.  To narrow down our dataset, we decided to use the top 6 teams with the highest attendance in 2019.  Through the filter() and arrange() functions we created new data frames with just the teams we are focusing on for the 2019 season which are the Dallas Cowboys, Green Bay Packers, Los Angeles Rams, New York Giants, Philadelphia Eagles, and Buffalo Bills.  

The first visualization we created was a line plot that visualizes the weekly attendance of the 6 football teams over the weeks of their 2019 season.  We utilized the ggplot() function to initialize this line plot.  The line plot helps to identify peak attendance weeks (e.g., playoffs or rivalry games) and low attendance weeks. Understanding when and why attendance varies can provide insights into factors affecting fan engagement.  While there does not seem to be seasonal trends in attendance, the line graph gives us a broader idea of the top 6 teams' attendance for each week and the areas to dive deeper into.  For example, the line graph shows a large dip in attendance for the Green Bay Packers in week 9 so it may be noteworthy to further analyze that week to learn what factors caused the dip.

We utilized the ggplot() function to create a bar plot that helps with comparing attendance based on weeks for the 6 teams that we focused on, Dallas Cowboys, Green Bay Packers, Los Angeles Rams, New York Giants, Philadelphia Eagles, and Buffalo Bills. From this, we noticed that there is always one week with no attendance for all 6 identified top attendance teams due to Bye weeks. In most cases, other than Green Bay Packers, there aren’t significant dips in attendance, but there are certain weeks that have higher attendance than others. This could be due to the game being a home or away game, due to a previous win, rivalry, or day of the week. Unique fan engagement could also play a role in some of these patterns since Philadelphia Eagles see a relatively stable attendance record. The Dallas Cowboys have more variance by week, but also have the highest attendance on weeks where their attendance peaks. We dove into Dallas Cowboys and potential reasons for their ups and downs in attendance. Turns out, Cowboys fans tend to only go to home games.

We wanted to understand if there was any impact on attendance the week after a win or loss, so we utilized the ggplot() function to create a scatter plot to show the attendance each week and filled each point to show whether the team lost for each of the 6 teams that we focused on. From this, we noticed that there is no apparent correlation between a win or loss in one week and attendance the following week. We also noticed that each team has certain weeks that have higher attendance than others, and we contribute this to rivalry games or games at “unique” times, such as Sunday night, Monday night, or Thursday night, as those games tend to be more watched and more popular. 

Recommendations: 
Our research found that Thursdays are a high attendance day and big rivalry games also have high attendance rates. A suggestion is for officials to schedule big rivalry games on less popular days because it will raise attendance on these days and Thursdays/Sundays will stay relatively the same because of the favorable timing. Additionally, the Cowboys only have high attendance at home games so their coaches and marketers should provide incentives for fans who go to away games. For instance, discounted hotels and flights for dedicated fans is something that the league can explore. 
